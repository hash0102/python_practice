## 14.1 URLをパースする `urllib.parse`

- `urllib.parse`モジュールは、**URLの解析、結合、エンコード/デコード**を行うための標準ライブラリ
- Web開発やスクレイピングなど、URLを扱う様々な場面で不可欠なツール
- このモジュールを使うことで、URLの各要素（スキーム、ホスト名、パスなど）を簡単に分解したり、逆に組み立てたりできる

### URLをパースする `urlparse()`

**`urlparse()`関数**
- `urlparse()`は、与えられたURLを6つの主要なコンポーネントに分割し、**`ParseResult`という名前のタプル風オブジェクトで返す**関数
  - これにより、URLの各部分に簡単にアクセスできるようになる
- **`urllib.parse.urlparse(url, scheme='', allow_fragments=True)`**
    - **`url`**： 
      - 解析したいURLを文字列で指定
    - **`scheme`**（オプション）：
      - URLにスキーム（例: `http`）がない場合に、デフォルトとして使用するスキームを指定する
    - **`allow_fragments`**（オプション）：
      - **`False`** に設定すると、フラグメント（`#`以降の部分）をパスの一部として扱う。
        - デフォルトは`True`

**`ParseResult`オブジェクトの属性**

- `urlparse()`は **`ParseResult`オブジェクトを返す**
  - これは、**`collections.namedtuple`のサブクラス** であり、**インデックスまたは属性名**で各コンポーネントにアクセスできる

| **属性名** | **説明** | **例（上記のURLの場合）** |
| --- | --- | --- |
| **`scheme`** | URLのプロトコル（例: `http`, `https`, `ftp`）。 | `'https'` |
| **`netloc`** | ネットワークの場所、ホスト名、ポート番号、認証情報などが含まれる。 | `'www.example.com:8080'` |
| **`path`** | サーバー上のリソースへのパス。 | `'/path/to/resource'` |
| **`params`** | パラメータ。通常はセミコロン（`;`）で区切られるが、最近のWebではあまり使われない。 | `''` |
| **`query`** | クエリ文字列。疑問符（`?`）以降の部分で、キーと値のペアが含まれる | `'query=value'` |
| **`fragment`** | フラグメント識別子。ハッシュ記号（`#`）以降の部分で、ページ内の特定の場所にジャンプするために使用される | `'fragment'` |

- これらの属性は、インデックスでもアクセスできる
  - 例えば、**`parsed_url[0]`** は **`scheme`**
  - **`parsed_url[1]`** は **`netloc`** を返す。

### クエリ文字列をパースする **`parse_qs()`**
- **`parse_qs()`** はURLのクエリ文字列を解析し、**辞書形式のオブジェクトに変換するための関数**
- ウェブアプリケーション開発やAPIとの連携において、**URLからパラメータを取得**する際によく使われる
- **`urllib.parse.parse_qs(qs, keep_blank_values=False, strict_parsing=False, encoding='utf-8', errors='replace')`**
    - **`qs`**：
      - 解析したいクエリ文字列を文字列で指定
        - 例：`'key1=value1&key2=value2'`
    - **`keep_blank_values`** （オプション）：
      - 空の値（例: `key=`）を保持するかどうかを`True`または`False`で指定
        - デフォルトは`False`で、この場合空のキーは無視される
    - **`strict_parsing`** （オプション）：
      - `True`に設定すると、不正なクエリ文字列に対して厳格にエラーを発生させる。
    - **`encoding`**（オプション）：
      - クエリ文字列のエンコーディングを指定
    - **`errors`**（オプション）：
      - エンコーディングエラーの処理方法を指定
- `parse_qs()`の戻り値は、キーと値が格納された**辞書**
    - 特に重要なのは、**値が常にリスト形式で返される**という点
    - これは、同じキーが複数回出現する可能性を考慮している
- 同じキー（`name`）が複数ある場合、値がリストにまとめられている
- `state`のように値がない場合、`keep_blank_values=True`を指定しないと辞書から除外される

### クエリ文字列を組み立てる `urlencode()`
- `urlencode()` は、Pythonの`urllib.parse`モジュールにある関数で、**辞書やタプルのリスト**などのデータを、**URLのクエリ文字列として使える形式に変換**する
  - これは、Webフォームからサーバーへデータを送信したり、APIリクエストを作成したりする際に不可欠なプロセス
- **`urlencode()`** の主な役割は、**特殊文字をパーセントエンコーディング（URLエンコーディング）に変換**すること
    - 例えば、スペースは`+`や`%20`に、`&`や`=`のような予約文字は`%26`や`%3D`に変換される
    - これにより、URLに含めることのできない文字を安全に送信できるようになる。
- **`urllib.parse.urlencode(query, doseq=False, safe='', encoding=None, errors=None)`**
    - **`query`**： 
      - エンコードしたいデータ。
        - **辞書**、または**キーと値のペアのタプルリスト**を指定
    - **`doseq`**：
      - **同じキーを持つ複数の値をどのように扱うか**を指定
        - **`False`** (デフォルト)：同じキーが複数ある場合、**リストをそのまま1つの文字列として扱う**
        - **`True`**：**リストを要素ごとに展開して、複数のクエリとして生成する**
            - 例：`'key=value1&key=value2'`
        - ※**`doseq`** が効くのは**値がリスト** のときだけで、**タプルのリスト**には影響しない
    - **`safe`**(オプション)：
      - パーセントエンコーディングから**除外する文字**を指定する
    - **`encoding`**(オプション)： 
      - **エンコードに使用する文字コードを指定**する

**`urlencode()`と`urlparse()`の連携**
- `urlencode()`は、`urlparse()`の逆の操作
  - `urlparse()`がURLを分解するのに対し
  - `urlencode()`はデータを組み立てるために使う
- 通常、これらの関数は以下のように組み合わせて使われる
1. `urlparse()`で**URLを解析**し、**既存のクエリ文字列を取得**
2. そのクエリ文字列を　**`parse_qs()`で辞書に変換**し、必要な変更を加える
3. 変更した辞書を **`urlencode()`で再度クエリ文字列に変換** 
4. 元のURLの他の部分と組み合わせて新しいURLを作成

### URLとして使用できる文字列に変換する `quote()`・`quote_plus()`

**`quote()`と`quote_plus()`の共通機能**
- 両関数とも、文字列中の**特殊文字をパーセントエンコーディングに変換**する
  - 例えば、日本語のような**マルチバイト文字**や、`&`, `?`, `/`のような**予約文字**が変換対象となる

**`quote()`と`quote_plus()`の違い**
- 最も重要な違いは、**スペース（     ``）の扱い**。

**`urllib.parse.quote()`**：
- スペースを **`%20`** に変換する。
- URLの**パス**（`path`）部分をエンコードするのに適している
  - パスの中では、**スペースは`%20`として扱う**のが一般的
- **`quote()`** は、**URLのパス部分**や、**スラッシュ（`/`）をそのまま保持** したい場合に便利

**`urllib.parse.quote_plus()`**：
- スペースを **`+`** 記号に変換する。
- URLの**クエリ文字列**（`query`）部分をエンコードするのに適している。
  - **Webフォームの送信などでは`+`がスペースを意味する**ことが多いため、こちらが使われる
- **`quote_plus()`** は、**URLのクエリ文字列として使うキーや値をエンコード**するのに適している

- 両関数には、**パーセントエンコーディングから除外する文字を指定できる`safe`引数**がある
    - **`safe`**：エンコードせずにそのままにしておきたい文字を文字列で指定

|             | **`quote()`**                           | **`quote_plus()`**                                      |
| ----------- | --------------------------------------- | ------------------------------------------------------- |
| **スペースの扱い** | `%20` に変換                               | `+` に変換                                                 |
| **主な用途**    | URL の **パス**部分のエンコード                    | URL の **クエリ文字列** のエンコード                                 |
| **その他**     | `/` は **デフォルトではエンコードされない**（safe="/"だから） | `/` も **エンコードされない**（safe="/"だから。`quote_plus` 固有の仕様ではない） |

### URLを結合する `urljoin()`
- `urljoin()`は、Pythonの`urllib.parse`モジュールにある関数で、**ベースURL**と**相対URL**を結合して**完全なURLを生成**するために使われる
- これは、Webサイト内のリンクをたどる際や、複数のURLを動的に組み立てる際に非常に便利

> #### **ベースURL（Base URL）とは**
>- 基準となる URL
>- 相対URLを完全な絶対URLに変換するときの「起点」になる
>
>例：
> ```
> https://example.com/articles/2025/
> ```
> - これが ベースURL なら、この URL を基準にして相対URLを解決する。

> #### **相対URL（Relative URL）とは**
>- ベースURLに対して相対的に書かれた URL
>- 単独では完全な URL にならない。
>- 例えば HTML 内のリンク：
> ```html
> <a href="about.html">About</a>
> ```
> - これは相対URL
> - どこを基準にするかはベースURLで決まる

> #### **ベース + 相対 = 絶対URL**
> 例：ベースURL
> ```
> https://example.com/articles/2025/
> ```
>
> 例：相対URL：
> ```
> about.html
> ```
> 合成すると：
> ```
> https://example.com/articles/2025/about.html
> ```

- **`urljoin()`**　は、以下のルールに基づいてURLを結合する
1. **ベースURLのスキームとネットロケーションを継承する：**
   - 相対URLにスキーム（例: `http`）やネットロケーション（例: `example.com`）が含まれていない場合、**ベースURLからそれらを継承する**
2. **絶対パスを優先する：**
  - 相対URLが`/`で始まる絶対パスの場合、**ベースURLのパス部分は無視され、相対URLのパスが使われる**
3. **完全なURLを優先する：**
   - 相対URLがスキームとネットロケーションの両方を含む**完全なURLの場合、ベースURLは無視され、相対URLがそのまま返される**

- **`urllib.parse.urljoin(base, url, allow_fragments=True)`**
    - **`base`**： 
      - 結合の基準となる**ベースURL**（文字列）
    - **`url`**：
      - ベースURLに対して結合する**相対URL**（文字列）
    - **`allow_fragments`**：
        - `False`に設定すると、フラグメント（`#`以降）がパスの一部として扱われる。
            - デフォルトは`True` (オプション)

**urllib_parse_module.py**

## 14.2 URLを開く `urllib.request`
- `urllib.request`は、Pythonの標準ライブラリで、
**URLを開いてデータを取得**するためのモジュール
- WebサイトからHTMLをダウンロードしたり、APIからJSONデータを取得したりする際に使われる

### 指定のURLを開く `urlopen()`
- `urlopen()`は、`urllib.request`モジュールの中でも最も基本的な関数で、**URLを指定してWebリソースにアクセス**する
- **`urllib.request.urlopen(url, data=None, timeout=socket._GLOBAL_DEFAULT_TIMEOUT, cafile=None, capath=None, cadefault=False, context=None)`**
    - **`url`**：
      - **アクセスするURL**を文字列で指定
    - **`data`** (オプション) ：
      - **リクエストボディに含めるデータ**を指定
        - 通常、**POSTリクエスト**で使われる
        - データを渡す際は、**`bytes`形式にエンコード**する必要がある
    - **`timeout`** (オプション)： 
      - タイムアウト時間を秒単位で指定
    - **`context`** (オプション)：
      - SSL/TLSの設定を制御するために使われる
- **戻り値**
    - `urlopen()`は **`http.client.HTTPResponse`オブジェクトを返す**
        - このオブジェクトは**ファイルのような振る舞い**をし、以下のメソッドで**データを読み取る**ことができる
            - **`read()`**： 
              - **レスポンスボディ全体**を`bytes`形式で読み込む
            - **`readline()`**：
              - **レスポンスボディを1行ずつ**読み込む
            - **`getcode()`**：
              - **HTTPステータスコード**（例: 200, 404）を取得する
            - **`getheaders()`**：
              - **レスポンスヘッダーをリスト形式**で取得する

### GET・POST以外のHTTPメソッドを扱う
- **`urllib.request.Request`** クラスは、**Webリクエストを細かく制御**するためのオブジェクト
    - `urlopen()`関数は**単純なGETリクエストを送信**するのに便利だが、**`Request`クラス**を使うことで、**HTTPメソッド**（GET, POST, DELETE, PUTなど）**の変更**、**カスタムヘッダー**（User-Agent, Content-Typeなど）**の追加を** したり、**リクエストボディを含めたり**することができる

- **`urllib.request.Request(url, data=None, headers={}, origin_req_host=None, unverifiable=False, method=None)`**
    - **`url`**： リクエストを送信するURL
    - **`data`**：リクエストボディに含めるデータ
        - **POSTやPUTリクエストで使われ**、`bytes`形式で指定する
    - **`headers`**： **辞書形式**でヘッダーを指定する
    - **`method`**：HTTPメソッドを文字列で指定する
      - （例: `'GET'`, `'POST'`, `'DELETE'`）
- `Request`オブジェクトを作成した後は、`urlopen()`関数の引数に渡して実行する

**例：urllib_request_module.py**

### レスポンスモジュール
- `urllib.request.urlopen()`を実行すると、レスポンスとして **`http.client.HTTPResponse`オブジェクト**が返される
- このオブジェクトは、**取得したWebリソースに関するさまざまな情報にアクセス**するための属性とメソッドを持っている

**`url`**
- `url`は **`response.url`** 属性、または **`response.geturl()`** メソッドで取得できる
  - **機能：** 
    - リクエストがリダイレクトされた場合、**最終的にアクセスしたURL**を返す
      - リダイレクトがなかった場合は、リクエストした元のURLが返される。
  - **戻り値**：
    - 最終的なURLを示す文字列

**`headers`**
- `headers`は、`response.headers`**属性、または**`response.info()`メソッドで取得できる。
- **機能**：
  - サーバーから返された**レスポンスヘッダー全体を辞書のようなオブジェクト**で取得する
- **戻り値：** 
  - **`http.client.HTTPMessage`オブジェクト**
    - これは辞書のように`headers['Content-Type']`のようなキーでアクセスできる。

**`status()`**
- `status`は、**`response.status`属性** 、または **`response.getcode()`メソッド** で取得できる
    - **機能**：HTTPリクエストの**ステータスコードを整数で返す**
      - **戻り値**：`200` (OK), `404` (Not Found), `500` (Internal Server Error)などの整数値

**例：urllib_request_module2.py**

## 14.4 Base16・Base64などへエンコードする `base64`

**`base64`モジュールとは**
- `base64`モジュールは、バイナリデータを**Base64エンコーディング**で処理するための標準ライブラリ
  - Base64とは、**バイナリデータをテキスト（ASCII文字）に変換するエンコード方式**の一つ
- この方式は、以下の目的で広く使われている
    - **バイナリデータをテキスト形式で送信**：
      - メールやJSON、XMLなど、バイナリデータをそのまま扱えないシステムで、画像や音声などのデータを安全にやり取りするため
    - **データの破損防止**：
      - `\n`や`\t`のような制御文字をなくすことで、システム間でデータが破損するリスクを減らす
- `base64`モジュールは、主に**エンコード**（バイナリ → テキスト）と**デコード**（テキスト → バイナリ）の機能を提供する

### Base64にエンコードする

**`b64encode()`メソッド**
- `b64encode()`は、**バイナリデータ**を**Base64形式のバイト文字列にエンコード**する最も基本的なメソッド
- `base64.b64encode(s, altchars=None)`
    - **`s`**： 
      - エンコードしたい**バイナリデータ**（`bytes`オブジェクト）
    - **`altchars`**（オプション）： 
      - URLなどで使われる`+`や`/`の代わりに、別の文字を使う場合に指定する

**※注意点**
- **`b64encode()`** は、入力としてstrオブジェクトではなく**bytesオブジェクトを要求**する
- 文字列をエンコードしたい場合は、**'utf-8'** などの**文字コードでエンコードしてから渡す**必要がある

### Base64からデコードする
**`b64decode()`とは**
- `b64decode()`は、**Base64形式**でエンコードされたバイト文字列を、**元のバイナリデータにデコード**するためのメソッド
  - これは、**`b64encode()`の逆の操作**にあたる
- **機能**：
  - **Base64でエンコード**された**バイト文字列**を、**元のバイナリデータ**に戻す
- **用途**： 
  - Base64でエンコードされたデータを、画像、音声、PDFなどのバイナリファイルとして復元したり、元のテキストデータに戻したりする際に使用する
- **`base64.b64decode(s, altchars=None, validate=False)`**
  - **`s`**：
    - デコードしたいBase64形式の**バイト文字列**（`bytes`オブジェクト）。
  - **`altchars`** （オプション）：
    - **`b64encode()`** で代替文字を使った場合に、ここで同じ文字を指定してデコードする
  - **`validate`**（オプション）：
    - `True`に設定すると、入力データが**正しいBase64形式であるかをチェック**し、不正な文字が含まれている場合はエラー（`binascii.Error`）を発生させる
    - デフォルトは`False`で、不正な文字は無視される

**※注意点**
- `b64decode()`は、**入力として`bytes`オブジェクトを要求**する
  - **文字列を渡すと`TypeError`が発生**するため、**`str.encode()`でバイト文字列に変換**してから渡す必要がある。
- また、**`validate=True`を使うことで、デコード時のエラーチェックを強化**できる。

**例：base64_module.py**